/*
 * Define modules options
 */


process {

  // Default commenter pour ne pas avoir les dossiers par defauts 
  //publishDir = [
  //  path: { "${params.outDir}/${task.process.tokenize(':')[-1].tokenize('_')[0]}" },
  //  mode: 'copy',
  //  saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
  //]

  withName:'getSoftwareVersions' {
    publishDir = [
      path: { "${params.outDir}/softwareVersions" },
      mode: 'copy'
    ]
  }

  withName:'outputDocumentation' {
    publishDir = [
      path: { "${params.summaryDir}" },
      mode: 'copy'
    ]
  }

  withName: 'bcAlign10X' {
    publishDir = [
      [
        path: { "${params.outDir}/bcAlign10X" },
        mode: 'copy',
        pattern: "*ReadsMatchingSorted.txt"
      ],
      [
        path: { "${params.outDir}/bcAlign10X" },
        mode: 'copy',
        pattern: "*Bowtie2.log"
      ],
      [
        path: { "${params.outDir}/bcAlign10X" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = '-N 1 -L 8 --rdg 0,7 --rfg 0,7 --mp 7,7 --ignore-quals --score-min L,0,-1 -t --no-unal --no-hd '
  }

  withName: 'bcAlign' {
    publishDir = [
      [
        path: { "${params.outDir}/bcAlign" },
        mode: 'copy',
        pattern: "*ReadsMatchingSorted.txt"
      ],
      [
        path: { "${params.outDir}/bcAlign" },
        mode: 'copy',
        pattern: "*_count_index.txt"
      ],
      [
        path: { "${params.outDir}/bcAlign" },
        mode: 'copy',
        pattern: "*Bowtie2.log"
      ],
      [
        path: { "${params.outDir}/bcAlign" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = '-N 1 -L 8 --rdg 0,7 --rfg 0,7 --mp 7,7 --ignore-quals --score-min L,0,-1 -t --no-unal --no-hd '
  }

  withName: 'joinBcIndexes' {
    publishDir = [
      [
        path: { "${params.outDir}/joinBcIndexes" },
        mode: 'copy',
        pattern: "*_read_barcodes.txt"
      ],
      [
        path: { "${params.outDir}/joinBcIndexes" },
        mode: 'copy',
        pattern: "*_bowtie2.log"
      ]
    ]
  }

  withName: 'bcTrim' {
    publishDir = [
      [
        path: { "${params.outDir}/bcTrim" },
        mode: 'copy',
        pattern: "*.fastq.gz"
      ],
      [
        path: { "${params.outDir}/bcTrim" },
        mode: 'copy',
        saveAs: {filename -> "logs/$filename"},
        pattern: "*log"
      ],
      [
        path: { "${params.outDir}/bcTrim" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = '--alignEndsType EndToEnd --outSAMtype BAM SortedByCoordinate --winAnchorMultimapNmax 1000  --outFilterMultimapNmax 1 --alignIntronMax 1 --peOverlapNbasesMin 10 --alignMatesGapMax 450 --limitGenomeGenerateRAM 25000000000 '
  }

  withName: 'starAlign' {
    publishDir = [
      [
        path: { "${params.outDir}/starAlign" },
        mode: 'copy',
        pattern: "*.bam"
      ],
      [
        path: { "${params.outDir}/starAlign" },
        mode: 'copy',
        saveAs: {filename -> "logs/$filename"},
        pattern: "*out"
      ],
      [
        path: { "${params.outDir}/starAlign" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = '--alignEndsType EndToEnd --winAnchorMultimapNmax 1000  --outFilterMultimapNmax 1 --alignIntronMax 1 --peOverlapNbasesMin 10 --alignMatesGapMax 450 --limitGenomeGenerateRAM 25000000000 '
  }

  withName: 'addFlags' {
    publishDir = [
      [
        path: { "${params.outDir}/addFlags" },
        mode: 'copy',
        pattern: "*.bam"
      ]
    ]
  }

  withName: 'removePCRdup' {
    publishDir = [
      [
        path: { "${params.outDir}/removePCRdup" },
        mode: 'copy',
        pattern: "*.bam"
      ],
      [
        path: { "${params.outDir}/removePCRdup" },
        mode: 'copy',
        pattern: "*.sam"
      ],
      [
        path: { "${params.outDir}/removePCRdup" },
        mode: 'copy',
        pattern: "*_count_PCR_duplicates.txt"
      ],
      [
        path: { "${params.outDir}/removePCRdup" },
        mode: 'copy',
        pattern: "*_countR1unmappedR2.txt"
      ],
      [
        path: { "${params.outDir}/removePCRdup" },
        mode: 'copy',
        pattern: "*_flagged.sorted.bam"
      ]
    ]
  }

  withName: 'removeRTdup' {
    publishDir = [
      [
        path: { "${params.outDir}/removeRTdup" },
        mode: 'copy',
        pattern: "*.bam"
      ],
      [
        path: { "${params.outDir}/removeRTdup" },
        mode: 'copy',
        pattern: "*_count_RT_duplicates.txt"
      ]
    ]
  }

  withName: 'removeWindowDup' {
    publishDir = [
      [
        path: { "${params.outDir}/removeWindowDup" },
        mode: 'copy',
        pattern: "*.bam"
      ],
      [
        path: { "${params.outDir}/removeWindowDup" },
        mode: 'copy',
        pattern: "*_removeWindowDup.log"
      ]
    ]
  }

  withName: 'removeBlackRegions' {
    publishDir = [
      [
        path: { "${params.outDir}/removeBlackRegions" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ],
      [
        path: { "${params.outDir}/removeBlackRegions" },
        mode: 'copy',
        pattern: "*BlackReg.bam"
      ],
      [
        path: { "${params.outDir}/removeBlackRegions" },
        mode: 'copy',
        pattern: "*BlackReg.bam.bai"
      ],
      [
        path: { "${params.outDir}/removeBlackRegions" },
        mode: 'copy',
        pattern: "*_rmDup.txt"
      ],
      
    ]
  }

  withName: 'countSummary' {
    publishDir = [
      [
        path: { "${params.outDir}/countSummary" },
        mode: 'copy',
        pattern: "*.log"
      ]
    ]
  }

  withName: 'distribUMIs' {
    publishDir = [
      [
        path: { "${params.outDir}/UMIdistribution" },
        mode: 'copy',
        pattern: "*.mqc"
      ],
      [
        path: { "${params.outDir}/UMIdistribution" },
        mode: 'copy',
        pattern: "*.pdf"
      ],
      [
        path: { "${params.outDir}/UMIdistribution" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
  }

  withName: 'bamToFrag' {
    publishDir = [
      [
        path: { "${params.outDir}/FragmentFiles" },
        mode: 'copy',
        pattern: "*.gz"
      ]
    ]
  }

  //SubWorkflow countMatricesPerBin
  withName: 'createBinMatrices' {
    publishDir = [
      [
        path: { "${params.outDir}/BinMatrices" },
        mode: 'copy',
        pattern: "*.zip"
      ],
      [
        path: { "${params.outDir}/BinMatrices" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = "-f ${params.minReadsPerCellmatrix} --tag XB -v"
  }

  //SubWorkflow countMatricesPerTSS
  withName: 'createTssMatrices' {
    publishDir = [
      [
        path: { "${params.outDir}/TssMatrices" },
        mode: 'copy',
        pattern: "*.zip"
      ],
      [
        path: { "${params.outDir}/TssMatrices" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = "-f ${params.minReadsPerCellmatrix} --tag XB -v"
  }

  withName: 'deeptoolsBamCoverage' {
    publishDir = [
      [
        path: { "${params.outDir}/bigwig" },
        mode: 'copy',
        pattern: "*.bigwig"
      ],
      [
        path: { "${params.outDir}/bigwig" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = "--normalizeUsing CPM --ignoreForNormalization chrX --binSize 50 --smoothLength 500 --extendReads 150"
  }

  withName: 'macs2Sharp' {
    publishDir = [
      [
        path: { "${params.outDir}/peaksSharp" },
        mode: 'copy',
        pattern: "*.Peak"
      ],
      [
        path: { "${params.outDir}/peaksSharp" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = "--nomodel --extsize 200 --keep-dup all -f BAM ${params.macs2_sharp} "
  }

  withName: 'mergePeaksSharp' {
    publishDir = [
      [
        path: { "${params.outDir}/peaksSharp" },
        mode: 'copy',
        pattern: "*.Peak"
      ],
      [
        path: { "${params.outDir}/peaksSharp" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = " -c 1,2,3 -d ${params.max_feature_dist_sharp} "
  }

  withName: 'macs2Broad' {
    publishDir = [
      [
        path: { "${params.outDir}/peaksBroad" },
        mode: 'copy',
        pattern: "*.Peak"
      ],
      [
        path: { "${params.outDir}/peaksBroad" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = "ext.args = "--nomodel --extsize 200 --keep-dup all -f BAM ${params.macs2_broad} "
  }

  withName: 'mergePeaksBroad' {
    publishDir = [
      [
        path: { "${params.outDir}/peaksBroad" },
        mode: 'copy',
        pattern: "*.Peak"
      ],
      [
        path: { "${params.outDir}/peaksBroad" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.txt') ? null : filename }
      ]
    ]
    ext.args = " -c 1,2,3 -d ${params.max_feature_dist_board} "
  }

  withName: 'multiqc' {
    publishDir = [
      [
        path: { "${params.outDir}/multiqc" },
        mode: 'copy',
        pattern: "*report.html"
      ]
    ]
  }

}